<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AFQ_TractProfileAlign</title>
  <meta name="keywords" content="AFQ_TractProfileAlign">
  <meta name="description" content="THIS FUNCTION IS STILL BEING DEVELOPED">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">functions</a> &gt; AFQ_TractProfileAlign.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>AFQ_TractProfileAlign
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>THIS FUNCTION IS STILL BEING DEVELOPED</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [params,mapv1,mapv1b,err] = AFQ_TractProfileAlign(v1,v2,numanchor,errmetric,show) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> THIS FUNCTION IS STILL BEING DEVELOPED
 Align two Tract Profiles by stretching one to match the other

 function [params,mapv1,mapv1b,err] = AFQ_TractProfileAlign(v1,v2,numanchor)

 This function will coregister the Tract Profile in vector 1 (v1) to the
 Tract Profile in vector 2 (v2).  This is done by using searching for an
 anchor point on v1 and a mapping of this anchor point to an equivalent
 point on v2. v1 is then interpolated with respect to this anchor point so
 that the two vectors match.  The search may have problems with local
 minimums when the number of anchor points is &gt; 1.

 Inputs:

 v1        - An input vector to coregister
 v2        - Target vector. v1 will be coregisterd to v2.
 numanchor - The number of anchor points on v1 to map to v2. There may be
             a problem with local minimum if you use more than 1
 errmetric - Error metric for fitting. Either 'R2' or 'MSE'
 show      - Plot out fitting proceedure. [True/False]

 Outputs:

 params    - Parameters of the transform.  These can be plugged into
             AFQ_TractProfileInterp to resample v1.
 mapv1     - v1 coregistered to v2 just based on stretching the vector
             along the x axis
 mapv1b    - v1 coregistered to v2 based on stretching it scaling it and
             offsetting it

 Example:

 v1 = evalgaussian1d([20 5 1 0],1:100); v2 = evalgaussian1d([40
 20 3 0],1:100); [params,mapv1,mapv1b] = AFQ_TractProfileAlign(v1,v2,2);
 figure; hold on; plot(v1,'r-'); plot(v2,'g-'); plot(mapv1,'b-');
 plot(mapv1b,'c-');</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_TractProfileInterp.html" class="code" title="function f = AFQ_TractProfileInterp(params,v,showmapping)">AFQ_TractProfileInterp</a>	function f = mapping(params,v,showmapping)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function err = costfun(v1,v2,params,metric,show,L)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [params,mapv1,mapv1b,err] = AFQ_TractProfileAlign(v1,v2,numanchor,errmetric,show)</a>
0002 <span class="comment">% THIS FUNCTION IS STILL BEING DEVELOPED</span>
0003 <span class="comment">% Align two Tract Profiles by stretching one to match the other</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% function [params,mapv1,mapv1b,err] = AFQ_TractProfileAlign(v1,v2,numanchor)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% This function will coregister the Tract Profile in vector 1 (v1) to the</span>
0008 <span class="comment">% Tract Profile in vector 2 (v2).  This is done by using searching for an</span>
0009 <span class="comment">% anchor point on v1 and a mapping of this anchor point to an equivalent</span>
0010 <span class="comment">% point on v2. v1 is then interpolated with respect to this anchor point so</span>
0011 <span class="comment">% that the two vectors match.  The search may have problems with local</span>
0012 <span class="comment">% minimums when the number of anchor points is &gt; 1.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% Inputs:</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% v1        - An input vector to coregister</span>
0017 <span class="comment">% v2        - Target vector. v1 will be coregisterd to v2.</span>
0018 <span class="comment">% numanchor - The number of anchor points on v1 to map to v2. There may be</span>
0019 <span class="comment">%             a problem with local minimum if you use more than 1</span>
0020 <span class="comment">% errmetric - Error metric for fitting. Either 'R2' or 'MSE'</span>
0021 <span class="comment">% show      - Plot out fitting proceedure. [True/False]</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Outputs:</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% params    - Parameters of the transform.  These can be plugged into</span>
0026 <span class="comment">%             AFQ_TractProfileInterp to resample v1.</span>
0027 <span class="comment">% mapv1     - v1 coregistered to v2 just based on stretching the vector</span>
0028 <span class="comment">%             along the x axis</span>
0029 <span class="comment">% mapv1b    - v1 coregistered to v2 based on stretching it scaling it and</span>
0030 <span class="comment">%             offsetting it</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% Example:</span>
0033 <span class="comment">%</span>
0034 <span class="comment">% v1 = evalgaussian1d([20 5 1 0],1:100); v2 = evalgaussian1d([40</span>
0035 <span class="comment">% 20 3 0],1:100); [params,mapv1,mapv1b] = AFQ_TractProfileAlign(v1,v2,2);</span>
0036 <span class="comment">% figure; hold on; plot(v1,'r-'); plot(v2,'g-'); plot(mapv1,'b-');</span>
0037 <span class="comment">% plot(mapv1b,'c-');</span>
0038 
0039 <span class="keyword">if</span> ismatrix(v1) &amp;&amp; (~exist(<span class="string">'v2'</span>,<span class="string">'var'</span>) || isempty(v2))
0040     v2 = nanmean(v1);
0041     nsub = size(v1,1);
0042 <span class="keyword">else</span>
0043     nsub = 1;
0044 <span class="keyword">end</span>
0045 
0046 <span class="keyword">if</span> ~exist(<span class="string">'numanchor'</span>,<span class="string">'var'</span>) || isempty(numanchor)
0047     numanchor = 1;
0048 <span class="keyword">end</span>
0049 
0050 <span class="keyword">if</span> ~exist(<span class="string">'show'</span>,<span class="string">'var'</span>) || isempty(show)
0051     show = 0;
0052 <span class="keyword">end</span>
0053 <span class="keyword">if</span> ~exist(<span class="string">'errmetric'</span>,<span class="string">'var'</span>) || isempty(errmetric)
0054     errmetric = <span class="string">'mse'</span>;
0055 <span class="keyword">end</span>
0056 <span class="comment">% define options for the optimization</span>
0057 options = optimset(<span class="string">'FunValCheck'</span>,<span class="string">'on'</span>,<span class="string">'MaxFunEvals'</span>,Inf,<span class="string">'MaxIter'</span>,Inf,<span class="string">'TolFun'</span>,1e-6,<span class="string">'TolX'</span>,1e-6);
0058 
0059 <span class="comment">% define bounds paramslb = zeros(1,numanchor); paramsub =</span>
0060 <span class="comment">% ones(1,numanchor);</span>
0061 paramslb = [-Inf -Inf zeros(1,2*numanchor)];
0062 paramsub = [Inf Inf ones(1,2*numanchor)];
0063 
0064 <span class="keyword">for</span> ii = 1:nsub
0065     <span class="keyword">if</span> sum(isnan(v1(ii,:))) &gt; 0
0066         err(ii) = 1;
0067         mapv1(ii,:) = v1(ii,:);
0068         mapv1b(ii,:) = v1(ii,:);
0069         <span class="keyword">continue</span>
0070     <span class="keyword">else</span>
0071         err(ii) = 0;
0072         
0073     <span class="keyword">end</span>
0074     <span class="comment">% define seeds for the parameter search</span>
0075     params0 = linspace(0,1,2+numanchor);
0076     params0 = repmat(params0(2:end-1),[2 1]);
0077     
0078     <span class="comment">% figure out seed for scale and offset with regression</span>
0079     <span class="comment">% The first parameter is scale, second is offset</span>
0080     h = pinv([v1(ii,:)' ones(length(v1(ii,:)),1)])*v2';
0081     
0082     <span class="comment">% construct final seed</span>
0083     params0 = [h(:)' params0(:)'];
0084     
0085     <span class="comment">% Fit parameters OLD: sqrt(1-nanreplace(corr(mapping(a,v1(ii,:))',v2'),-1))</span>
0086     [params,d,d,exitflag,output] = <span class="keyword">...</span>
0087         lsqnonlin(@(params) <a href="#_sub1" class="code" title="subfunction err = costfun(v1,v2,params,metric,show,L)">costfun</a>(v1(ii,:),v2,params,errmetric,show) , <span class="keyword">...</span>
0088         params0,paramslb,paramsub,options);
0089     <span class="comment">% ensure good convergence</span>
0090     assert(exitflag &gt; 0);
0091     
0092     <span class="comment">% Apply stretching to v1 so it matches v2</span>
0093     mapv1(ii,:) = <a href="AFQ_TractProfileInterp.html" class="code" title="function f = AFQ_TractProfileInterp(params,v,showmapping)">AFQ_TractProfileInterp</a>(params(3:end),v1(ii,:));
0094     <span class="comment">% Apply scale and offset</span>
0095     mapv1b(ii,:) = params(1)*mapv1(ii,:) + params(2);
0096 <span class="keyword">end</span>
0097 
0098 <span class="comment">% Plot the origional vector and the transformed</span>
0099 <span class="keyword">if</span> show == 1
0100     figure;hold;
0101     plot(v2,<span class="string">'k'</span>);plot(v1,<span class="string">'b'</span>);plot(mapv1,<span class="string">'r'</span>);
0102     legend({<span class="string">'Destination'</span> <span class="string">'Origional'</span> <span class="string">'Transformed'</span>})
0103 <span class="keyword">end</span>
0104 
0105 <span class="keyword">return</span>
0106 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0107 
0108 <a name="_sub1" href="#_subfunctions" class="code">function err = costfun(v1,v2,params,metric,show,L)</a>
0109 <span class="comment">% Cost function for fitting algorithm. Params(1) is the gain factor.</span>
0110 <span class="comment">% Params(2) is the offset. Params(3:end) are anchor points and mappings.</span>
0111 
0112 <span class="keyword">if</span> ~exist(<span class="string">'metric'</span>,<span class="string">'var'</span>) || isempty(metric)
0113     metric = <span class="string">'mse'</span>;
0114 <span class="keyword">end</span>
0115 <span class="keyword">if</span> ~exist(<span class="string">'L'</span>,<span class="string">'var'</span>) || isempty(L)
0116     L = 0;
0117 <span class="keyword">end</span>
0118 <span class="comment">% Use coeficient of determination (R2) as error metric</span>
0119 <span class="keyword">switch</span>(metric)
0120     <span class="keyword">case</span>{<span class="string">'R2'</span> <span class="string">'r2'</span>}
0121         v1Out = (params(1)*<a href="AFQ_TractProfileInterp.html" class="code" title="function f = AFQ_TractProfileInterp(params,v,showmapping)">AFQ_TractProfileInterp</a>(params(3:end),v1, show) + params(2));
0122         R2 = sum((v2-v1Out).^2)./sum((v2 - mean(v2)).^2);
0123         <span class="comment">% Error is defined as the percent of unexplained variance. We take the sqrt</span>
0124         <span class="comment">% because lsq nonline squares error by default</span>
0125         err = sqrt(1 - R2);
0126         
0127     <span class="keyword">case</span>{<span class="string">'mse'</span>,<span class="string">'MSE'</span>}
0128         <span class="comment">% Squared difference between input and output</span>
0129         err = v2 - (params(1)*<a href="AFQ_TractProfileInterp.html" class="code" title="function f = AFQ_TractProfileInterp(params,v,showmapping)">AFQ_TractProfileInterp</a>(params(3:end),v1, show) + params(2));
0130         <span class="comment">% Calculate the difference between the anchor point and the</span>
0131         <span class="comment">% mapping</span>
0132         d = params(3:2:end) - params(4:2:end);
0133         <span class="comment">% Create a second error metric that is the sum of the differences</span>
0134         <span class="comment">% scaled by some weight (L).</span>
0135         err2 = sum(d.^2)*L;
0136         <span class="comment">% Add this to the mean squared error</span>
0137         err = abs(err)+err2;
0138        
0139 <span class="keyword">end</span>
0140</pre></div>
<hr><address>Generated on Wed 14-Nov-2012 17:12:08 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>