<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AFQ_MakeFGProbabilityMap</title>
  <meta name="keywords" content="AFQ_MakeFGProbabilityMap">
  <meta name="description" content="Make a fiber tract probability map from fiber group segmentations">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">functions</a> &gt; AFQ_MakeFGProbabilityMap.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>AFQ_MakeFGProbabilityMap
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Make a fiber tract probability map from fiber group segmentations</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [fgPmap, fgEndPmap] = AFQ_MakeFGProbabilityMap(dtPaths,fgPaths,writeImage) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Make a fiber tract probability map from fiber group segmentations

 [fgPmap, fgEndPmap] = AFQ_MakeFGProbabilityMap(dtPaths, fgPaths, [writeImage = false])

 Make a nifti image of a fiber tract probability map from fiber group
 segmentations in a sample of subjects. Each voxel in the resulting
 probability map will represent the number of subjects with fibers in that
 voxel. The resulting nifti images will be in MNI space.

 Inputs:

 dtPaths   = A cell array of paths to each subject's dt6.mat file or and
             afq structure. If an afq structure is passed in then paths
             will be extracted from the structure
 fgPaths   = A cell array of paths to each subject's fiber group or if an
             afq structure was passed in then simply the name of the fiber
             group is sufficient.
 writeImage= Give the path to where you would like the probability map to
             be written (if you would like it to be saved)

 Outputs:

 fgPmap    = A nifti image of the fiber tract probability map
 fgEndPmap = A nifti image of the fiber tract endpoint probability map
 

 Copyright Jason D. Yeatman, November 2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_directories.html" class="code" title="function [AFQbase AFQdata AFQfunc AFQutil AFQdoc AFQgui] = AFQ_directories">AFQ_directories</a>	Returns a path to the AFQ directories</li><li><a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>	Get value from afq structure</li><li><a href="../utilities/isafq.html" class="code" title="function log = isafq(afq)">isafq</a>	Check if a variable is an afq structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [fgPmap, fgEndPmap] = AFQ_MakeFGProbabilityMap(dtPaths,fgPaths,writeImage)</a>
0002 <span class="comment">% Make a fiber tract probability map from fiber group segmentations</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% [fgPmap, fgEndPmap] = AFQ_MakeFGProbabilityMap(dtPaths, fgPaths, [writeImage = false])</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Make a nifti image of a fiber tract probability map from fiber group</span>
0007 <span class="comment">% segmentations in a sample of subjects. Each voxel in the resulting</span>
0008 <span class="comment">% probability map will represent the number of subjects with fibers in that</span>
0009 <span class="comment">% voxel. The resulting nifti images will be in MNI space.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Inputs:</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% dtPaths   = A cell array of paths to each subject's dt6.mat file or and</span>
0014 <span class="comment">%             afq structure. If an afq structure is passed in then paths</span>
0015 <span class="comment">%             will be extracted from the structure</span>
0016 <span class="comment">% fgPaths   = A cell array of paths to each subject's fiber group or if an</span>
0017 <span class="comment">%             afq structure was passed in then simply the name of the fiber</span>
0018 <span class="comment">%             group is sufficient.</span>
0019 <span class="comment">% writeImage= Give the path to where you would like the probability map to</span>
0020 <span class="comment">%             be written (if you would like it to be saved)</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% Outputs:</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% fgPmap    = A nifti image of the fiber tract probability map</span>
0025 <span class="comment">% fgEndPmap = A nifti image of the fiber tract endpoint probability map</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% Copyright Jason D. Yeatman, November 2012</span>
0029 
0030 <span class="keyword">if</span> ~exist(<span class="string">'fgPaths'</span>,<span class="string">'var'</span>) || isempty(fgPaths)
0031     error(<span class="string">'Please provide paths to the fiber groups'</span>)
0032 <span class="keyword">elseif</span> ischar(fgPaths)
0033     <span class="keyword">if</span> <a href="../utilities/isafq.html" class="code" title="function log = isafq(afq)">isafq</a>(dtPaths)
0034         <span class="comment">% Get the fiber group names from the afq structure and make them</span>
0035         <span class="comment">% lower case</span>
0036         fgnames = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(dtPaths,<span class="string">'fgnames'</span>);
0037         <span class="comment">% Format the name of the fiber group to remove spaces etc</span>
0038         name = mrvParamFormat(fgPaths);
0039         <span class="keyword">for</span> jj = 1:length(fgnames)
0040             fgnames{jj} = mrvParamFormat(dtPaths.fgnames{jj});
0041         <span class="keyword">end</span>
0042         <span class="comment">% Check if the desired fiber group is in the structure and get it's</span>
0043         <span class="comment">% number if it is</span>
0044         fgnum = find(strcmpi(name,fgnames));
0045     <span class="keyword">else</span>
0046        error(<span class="string">'Please provide an afq structure or paths to the fiber groups'</span>) 
0047     <span class="keyword">end</span>
0048 <span class="keyword">end</span>
0049 
0050 <span class="comment">% Check the dtPaths. If an afq structure was passed in the get the paths</span>
0051 <span class="comment">% out of it</span>
0052 <span class="keyword">if</span> ~exist(<span class="string">'dtPaths'</span>,<span class="string">'var'</span>) || isempty(dtPaths)
0053     error(<span class="string">'please provide paths to each subjects dt6 file'</span>);
0054 <span class="keyword">elseif</span> <a href="../utilities/isafq.html" class="code" title="function log = isafq(afq)">isafq</a>(dtPaths)
0055    dtPaths = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(dtPaths, <span class="string">'dt6path'</span>); 
0056 <span class="keyword">end</span>
0057 <span class="keyword">if</span> ~exist(<span class="string">'writeImage'</span>,<span class="string">'var'</span>) || isempty(writeImage)
0058     writeImage = 0;
0059 <span class="keyword">elseif</span> writeImage == 1
0060     <span class="comment">% If no directory is specified save the image in the AFQ data directory</span>
0061     [~, writeImage] = <a href="AFQ_directories.html" class="code" title="function [AFQbase AFQdata AFQfunc AFQutil AFQdoc AFQgui] = AFQ_directories">AFQ_directories</a>;
0062     fprintf(<span class="string">'\nWriting probability map to %s'</span>,writeImage)
0063 <span class="keyword">end</span>
0064 
0065 <span class="comment">% If the fiber group was one contained in an afq structure that was passed</span>
0066 <span class="comment">% in then build the correct fiber group paths</span>
0067 <span class="keyword">if</span> exist(<span class="string">'fgnum'</span>,<span class="string">'var'</span>) &amp;&amp; ~isempty(fgnum)
0068     fgPaths = cell(size(dtPaths));
0069     <span class="keyword">for</span> ii = 1:length(dtPaths)
0070         fgPaths{ii} = fullfile(fileparts(dtPaths{ii}),<span class="string">'fibers'</span>, <span class="string">'MoriGroups.mat'</span>);
0071     <span class="keyword">end</span>
0072     <span class="comment">% If the fiber group was not in the afq structure then assume it is the</span>
0073     <span class="comment">% name of another fiber group within each subject's fibers directory</span>
0074 <span class="keyword">elseif</span> exist(<span class="string">'fgnum'</span>,<span class="string">'var'</span>) &amp;&amp; isempty(fgnum)
0075     name = fgPaths;
0076     fgnum = 1;
0077     <span class="keyword">for</span> ii = 1:length(dtPaths)
0078         fgPaths{ii} = fullfile(fileparts(dtPaths{ii}),<span class="string">'fibers'</span>, name);
0079     <span class="keyword">end</span>
0080 <span class="keyword">else</span>
0081     fgnum = 1;
0082 <span class="keyword">end</span>
0083 <span class="comment">% Initialize spm defualts for normalization</span>
0084 spm_defaults; <span class="keyword">global</span> defaults; params = defaults.normalise.estimate;
0085 <span class="comment">% spm_get_defaults - For SPM8</span>
0086 <span class="comment">% Set the directory where templates can be found</span>
0087 tdir = fullfile(fileparts(which(<span class="string">'mrDiffusion.m'</span>)), <span class="string">'templates'</span>);
0088 <span class="comment">% Spatially normalize diffusion data with the MNI (ICBM) template</span>
0089 template = fullfile(tdir,<span class="string">'MNI_JHU_T2.nii.gz'</span>);
0090 <span class="comment">% Load the template image</span>
0091 tIm = readFileNifti(template);
0092 
0093 <span class="comment">% Allocate a 4 dimensional array where the 4th dimension corresponds to</span>
0094 <span class="comment">% an image of each subject's fiber group</span>
0095 fgIm = zeros([size(tIm.data) length(dtPaths)]);
0096 fgEndIm = zeros([size(tIm.data) length(dtPaths)]);
0097 
0098 <span class="comment">% loop over each subject</span>
0099 <span class="keyword">for</span> ii = 1:length(dtPaths)
0100     <span class="comment">%% Load fiber group and dt6</span>
0101     
0102     fg = dtiReadFibers(fgPaths{ii});
0103     <span class="comment">% In case fg contains many groups, extract the correct one</span>
0104     fg = fg(fgnum);
0105     dt = dtiLoadDt6(dtPaths{ii});
0106     
0107     <span class="comment">%% Compute spatial normalization</span>
0108     
0109     <span class="comment">% Rescale b0 image values to get better gary/white/CSF contrast</span>
0110     alignIm = mrAnatHistogramClip(double(dt.b0),0.3,0.99);
0111     <span class="comment">% Compute normalization</span>
0112     [sn, Vtemplate, invDef] = mrAnatComputeSpmSpatialNorm(alignIm, dt.xformToAcpc, template, params);
0113     
0114     <span class="comment">%% Transform fibers to MNI space and make an image of the fiber group</span>
0115     
0116     <span class="comment">% Spatially normalize fibers</span>
0117     fg_sn = dtiXformFiberCoords(fg, invDef);
0118     <span class="comment">% Concatinate all the fiber coordinates</span>
0119     fc = horzcat(fg_sn.fibers{:})';
0120     <span class="comment">% Construct another array with the start and endpoints of each fiber</span>
0121     <span class="comment">% group</span>
0122     fcEnd = [];
0123     <span class="keyword">for</span> jj=1:length(fg_sn.fibers)
0124         fcEnd = vertcat(fcEnd,[fg_sn.fibers{jj}(:,1) fg_sn.fibers{jj}(:,end)]');
0125     <span class="keyword">end</span>
0126     <span class="comment">% Remove any coordinates that are nans. This can happen if the</span>
0127     <span class="comment">% coordinates are outside of the MNI image</span>
0128     fc = fc(~isnan(fc(:,1)),:);
0129     fcEnd = fcEnd(~isnan(fcEnd(:,1)),:);
0130     
0131     <span class="comment">% Transform the fiber coordinates to image indices by applying the</span>
0132     <span class="comment">% affine stored in the header of the MNI template image used for</span>
0133     <span class="comment">% normalization. This will shift, scale and rotate the coordinates if</span>
0134     <span class="comment">% necessary</span>
0135     fc    = mrAnatXformCoords(tIm.qto_ijk, fc);
0136     fcEnd = mrAnatXformCoords(tIm.qto_ijk, fcEnd);
0137     <span class="comment">% Determine the unique coordinates</span>
0138     fcU    = unique(round(fc),<span class="string">'rows'</span>);
0139     fcEndU = unique(round(fcEnd),<span class="string">'rows'</span>);
0140     <span class="comment">% Convert coordinates to image indices with respect to the template</span>
0141     <span class="comment">% image that was used for normalization</span>
0142     ind    = sub2ind(size(tIm.data),fcU(:,1),fcU(:,2),fcU(:,3));
0143     indEnd = sub2ind(size(tIm.data),fcEndU(:,1),fcEndU(:,2),fcEndU(:,3));
0144     <span class="comment">% Create an image of zeros the size of the template image</span>
0145     tmpIm    = zeros(size(tIm.data));
0146     tmpEndIm = zeros(size(tIm.data));
0147     <span class="comment">% Put ones at each location where there is a fiber for this subject</span>
0148     tmpIm(ind)       = 1;
0149     tmpEndIm(indEnd) = 1;
0150     <span class="comment">% Add this image to the 4th dimension of what will become our fiber</span>
0151     <span class="comment">% probability map</span>
0152     fgIm(:,:,:,ii)    = tmpIm;
0153     fgEndIm(:,:,:,ii) = tmpEndIm;
0154 <span class="keyword">end</span>
0155 
0156 <span class="comment">%% Create a probability map</span>
0157 
0158 <span class="comment">% To make sure that we get the transforms correct we will steal all the</span>
0159 <span class="comment">% header information from the MNI template image</span>
0160 fgPmap    = tIm;
0161 fgEndPmap = tIm;
0162 <span class="comment">% Name it based on the last fiber group that was loaded (but remove capital</span>
0163 <span class="comment">% letters and spaces)</span>
0164 fgPmap.fname = mrvParamFormat([fg.name <span class="string">'_probmap.nii.gz'</span>]);
0165 fgEndPmap.fname = mrvParamFormat([fg.name <span class="string">'_endpoint_probmap.nii.gz'</span>]);
0166 
0167 <span class="comment">% Count how many subjects had fibers in each voxel by summing across the</span>
0168 <span class="comment">% 4th dimension of fgIm. This is our probability map. We replace the data</span>
0169 <span class="comment">% within the template image with this new template data.</span>
0170 fgPmap.data    = sum(fgIm,4);
0171 fgEndPmap.data = sum(fgEndIm,4);
0172 <span class="comment">% Some visualization programs use this scaling.</span>
0173 fgPmap.cal_max    = max(fgPmap.data(:));
0174 fgEndPmap.cal_max = max(fgEndPmap.data(:));
0175 
0176 
0177 <span class="comment">%% Save the image if desired</span>
0178 
0179 <span class="keyword">if</span> ischar(writeImage)
0180     curdir = pwd;
0181     cd(writeImage);
0182     writeFileNifti(fgPmap);
0183     writeFileNifti(fgEndPmap);
0184     cd(curdir);
0185 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 05-Dec-2012 12:03:42 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>