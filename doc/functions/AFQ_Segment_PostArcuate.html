<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AFQ_Segment_PostArcuate</title>
  <meta name="keywords" content="AFQ_Segment_PostArcuate">
  <meta name="description" content="Define the posterior segment of the arcuate from a wholebrain fiber group">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">functions</a> &gt; AFQ_Segment_PostArcuate.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>AFQ_Segment_PostArcuate
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Define the posterior segment of the arcuate from a wholebrain fiber group</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [L_FG R_FG L_roi_2 L_roi_3 R_roi_2 R_roi_3] = AFQ_Segment_PostArcuate(dt, wholebrainFG, sub_dir, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Define the posterior segment of the arcuate from a wholebrain fiber group

 [L_FG R_FG L_roi_2 L_roi_3 R_roi_2 R_roi_3] = AFQ_Segment_PostArcuate(dt, wholebrainFG, sub_dir, varargin)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_AddImageTo3dPlot.html" class="code" title="function h = AFQ_AddImageTo3dPlot(nifti, slice, cmap, rescale, alpha, varargin)">AFQ_AddImageTo3dPlot</a>	Add a slice from a nifti image to a 3D plot</li><li><a href="AFQ_LoadROIs.html" class="code" title="function [roi1 roi2] = AFQ_LoadROIs(fgNumber,sub_dir)">AFQ_LoadROIs</a>	Load the two ROIs used to define a fiber group</li><li><a href="AFQ_RenderFibers.html" class="code" title="function lightH = AFQ_RenderFibers(fg,varargin)">AFQ_RenderFibers</a>	Render a fiber group and tract profile in 3-D</li><li><a href="AFQ_RenderRoi.html" class="code" title="function h = AFQ_RenderRoi(roi, color, method, render)">AFQ_RenderRoi</a>	Render an ROI as a 3D surface</li><li><a href="AFQ_WholebrainTractography.html" class="code" title="function fg = AFQ_WholebrainTractography(dt,run_mode,params)">AFQ_WholebrainTractography</a>	Perform whole brain deterministic tractography within a white matter mask</li><li><a href="AFQ_directories.html" class="code" title="function [AFQbase AFQdata AFQfunc AFQutil AFQdoc AFQgui] = AFQ_directories">AFQ_directories</a>	Returns a path to the AFQ directories</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [L_FG R_FG L_roi_2 L_roi_3 R_roi_2 R_roi_3] = AFQ_Segment_PostArcuate(dt, wholebrainFG, sub_dir, varargin)</a>
0002 <span class="comment">% Define the posterior segment of the arcuate from a wholebrain fiber group</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% [L_FG R_FG L_roi_2 L_roi_3 R_roi_2 R_roi_3] = AFQ_Segment_PostArcuate(dt, wholebrainFG, sub_dir, varargin)</span>
0005 <span class="comment">%</span>
0006 
0007 <span class="comment">%% Argument checking</span>
0008 <span class="keyword">if</span> ~exist(<span class="string">'dt'</span>,<span class="string">'var'</span>) || isempty(dt)
0009     error(<span class="string">'dt6 file is needed'</span>);
0010 <span class="keyword">elseif</span> ischar(dt)
0011     dt = dtiLoadDt6(dt);
0012 <span class="keyword">end</span>
0013 <span class="keyword">if</span> ~exist(<span class="string">'wholebrainFG'</span>,<span class="string">'var'</span>) || isempty(wholebrainFG)
0014     fprintf(<span class="string">'Wholebrain fiber group was not supplied. Tracking fibers'</span>);
0015     wholebrainFG = <a href="AFQ_WholebrainTractography.html" class="code" title="function fg = AFQ_WholebrainTractography(dt,run_mode,params)">AFQ_WholebrainTractography</a>(dt);
0016 <span class="keyword">elseif</span> ischar(wholebrainFG) &amp;&amp; exist(wholebrainFG,<span class="string">'file'</span>)
0017     wholebrainFG = dtiReadFibers(wholebrainFG);
0018 <span class="keyword">elseif</span> ischar(wholebrainFG) &amp;&amp; ~exist(wholebrainFG,<span class="string">'file'</span>)
0019     fprintf(<span class="string">'Wholebrain fiber group was not found. Tracking fibers'</span>);
0020     wholebrainFG = <a href="AFQ_WholebrainTractography.html" class="code" title="function fg = AFQ_WholebrainTractography(dt,run_mode,params)">AFQ_WholebrainTractography</a>(dt);
0021 <span class="keyword">end</span>
0022 <span class="keyword">if</span> ~exist(<span class="string">'sub_dir'</span>,<span class="string">'var'</span>) || isempty(sub_dir)
0023     sub_dir = fileparts(dt.dataFile);
0024 <span class="keyword">end</span>
0025 <span class="comment">% Check if inverse deformation was passed in so computations can be skipped</span>
0026 <span class="keyword">if</span> ~isempty(varargin)
0027     <span class="keyword">for</span> ii = 1:length(varargin)
0028         <span class="keyword">if</span> isstruct(varargin{ii}) &amp;&amp; isfield(varargin{ii},<span class="string">'deformX'</span>)<span class="keyword">...</span>
0029                 &amp;&amp; isfield(varargin{ii},<span class="string">'coordLUT'</span>)<span class="keyword">...</span>
0030                 &amp;&amp; isfield(varargin{ii},<span class="string">'inMat'</span>)
0031             invDef= varargin{1};
0032         <span class="keyword">end</span>
0033     <span class="keyword">end</span>
0034 <span class="keyword">end</span>
0035 
0036 <span class="comment">%% Create ROIs and segment the posterior segment of the arcuate</span>
0037 <span class="comment">% Path to the templates directory</span>
0038 tdir = fullfile(fileparts(which(<span class="string">'mrDiffusion.m'</span>)), <span class="string">'templates'</span>);
0039 template = fullfile(tdir,<span class="string">'MNI_EPI.nii.gz'</span>);
0040 
0041 <span class="comment">% Path to the VOF ROIs in MNI space</span>
0042 AFQbase = <a href="AFQ_directories.html" class="code" title="function [AFQbase AFQdata AFQfunc AFQutil AFQdoc AFQgui] = AFQ_directories">AFQ_directories</a>;
0043 <span class="comment">% L_roi_2 = fullfile(AFQbase,'templates', 'L_Arcuate_PostSegment.nii.gz');</span>
0044 <span class="comment">% R_roi_2 = fullfile(AFQbase,'templates', 'R_Arcuate_PostSegment.nii.gz');</span>
0045 L_roi_3 = fullfile(AFQbase,<span class="string">'templates'</span>, <span class="string">'L_Parietal.nii.gz'</span>);
0046 R_roi_3 = fullfile(AFQbase,<span class="string">'templates'</span>, <span class="string">'R_Parietal.nii.gz'</span>);
0047 <span class="comment">% L_roi_3 = fullfile(AFQbase,'templates', 'L_LateralParietal.nii.gz');</span>
0048 <span class="comment">% R_roi_3 = fullfile(AFQbase,'templates', 'R_LateralParietal.nii.gz');</span>
0049 
0050 <span class="comment">% Compute spatial normalization</span>
0051 <span class="keyword">if</span> ~exist(<span class="string">'invDef'</span>,<span class="string">'var'</span>) || isempty(invDef)
0052     [sn, Vtemplate, invDef] = mrAnatComputeSpmSpatialNorm(dt.b0, dt.xformToAcpc, template);
0053 <span class="keyword">end</span>
0054 
0055 <span class="comment">% Load up template ROIs in MNI space and transform them to the subjects</span>
0056 <span class="comment">% native space.  dtiCreateRoiFromMniNifti also saves the ROIs</span>
0057 <span class="comment">%[~, ~, L_roi_2]=dtiCreateRoiFromMniNifti(dt.dataFile, L_roi_2, invDef, 1);</span>
0058 [~, ~, L_roi_3]=dtiCreateRoiFromMniNifti(dt.dataFile, L_roi_3, invDef, 1);
0059 <span class="comment">%[~, ~, R_roi_2]=dtiCreateRoiFromMniNifti(dt.dataFile, R_roi_2, invDef, 1);</span>
0060 [~, ~, R_roi_3]=dtiCreateRoiFromMniNifti(dt.dataFile, R_roi_3, invDef, 1);
0061 
0062 <span class="comment">% Load up predefined ROIs for the Arcuate fasciculus. These are computed in</span>
0063 <span class="comment">% AFQ_SegmentFiberGroups</span>
0064 [L_roi_not, L_roi_1] = <a href="AFQ_LoadROIs.html" class="code" title="function [roi1 roi2] = AFQ_LoadROIs(fgNumber,sub_dir)">AFQ_LoadROIs</a>(19,sub_dir);
0065 [R_roi_not, R_roi_1] = <a href="AFQ_LoadROIs.html" class="code" title="function [roi1 roi2] = AFQ_LoadROIs(fgNumber,sub_dir)">AFQ_LoadROIs</a>(20,sub_dir);
0066 
0067 <span class="comment">% To eliminate fibers that head too far anterior we will create a full</span>
0068 <span class="comment">% plane at the y coordinate of the anterior slf roi (around the central</span>
0069 <span class="comment">% sulcus) and remove fibers that intersect this ROI</span>
0070 L_roi_not = dtiRoiMakePlane([-60,mean(L_roi_not.coords(:,2)),-60; 60,mean(L_roi_not.coords(:,2)),80]);
0071 R_roi_not = dtiRoiMakePlane([-60,mean(R_roi_not.coords(:,2)),-60; 60,mean(R_roi_not.coords(:,2)),80]);
0072 
0073 <span class="comment">% Intersect the wholebrain fiber group with the ROIs to retain only fibers</span>
0074 <span class="comment">% that correspond to the posterior segment of the arcuate</span>
0075 L_FG = dtiIntersectFibersWithRoi([],<span class="string">'and'</span>,[],L_roi_1,wholebrainFG);
0076 
0077 <span class="comment">% We want fibers that are traveling superior to inferior as they pass</span>
0078 <span class="comment">% through the first ROI.  To do this we will restrict the ROI to voxels</span>
0079 <span class="comment">% with superior-inferior orientation and repeate this process for planes</span>
0080 <span class="comment">% directly above and below the ROI</span>
0081 <span class="keyword">for</span> ii = -3:3
0082     roi_tmp = L_roi_1;
0083     <span class="comment">% Shift the roi</span>
0084     roi_tmp.coords(:,3) = roi_tmp.coords(:,3) + ii;
0085     <span class="comment">% Compute the PDD at each point in each ROI</span>
0086     roi_pdd = dtiGetValFromTensors(dt.dt6, roi_tmp.coords, inv(dt.xformToAcpc), <span class="string">'pdd'</span>);
0087     <span class="comment">% Find every coordinate in each VOF ROI where the PDD is in the Z direction</span>
0088     [~, roi_pddZ] = max(abs(roi_pdd),[],2);
0089     roi_pddZ = roi_pddZ == 3;
0090     <span class="comment">% Retain VOF ROI coordinates that have a PDD in the Z direction</span>
0091     roi_tmp.coords = roi_tmp.coords(roi_pddZ,:);
0092     L_FG = dtiIntersectFibersWithRoi([],<span class="string">'and'</span>,[],roi_tmp,L_FG);
0093 <span class="keyword">end</span>
0094 <span class="comment">%L_FG = dtiIntersectFibersWithRoi([],'and',[],L_roi_2,L_FG);</span>
0095 <span class="comment">% Make sure endpoints are in the parietal lobe</span>
0096 L_FG = dtiIntersectFibersWithRoi([],<span class="string">'endpoints'</span>,4,L_roi_3,L_FG);
0097 <span class="comment">% And that fibers do not head to far anterior</span>
0098 L_FG = dtiIntersectFibersWithRoi([],<span class="string">'not'</span>,[],L_roi_not,L_FG);
0099 
0100 <span class="comment">% Same for the right hemisphere fiber group</span>
0101 R_FG = dtiIntersectFibersWithRoi([],<span class="string">'and'</span>,[],R_roi_1,wholebrainFG);
0102 <span class="keyword">for</span> ii = -3:3
0103     roi_tmp = R_roi_1;
0104     <span class="comment">% Shift the roi</span>
0105     roi_tmp.coords(:,3) = roi_tmp.coords(:,3) + ii;
0106     <span class="comment">% Compute the PDD at each point in each ROI</span>
0107     roi_pdd = dtiGetValFromTensors(dt.dt6, roi_tmp.coords, inv(dt.xformToAcpc), <span class="string">'pdd'</span>);
0108     <span class="comment">% Find every coordinate in each VOF ROI where the PDD is in the Z direction</span>
0109     [~, roi_pddZ] = max(abs(roi_pdd),[],2);
0110     roi_pddZ = roi_pddZ == 3;
0111     <span class="comment">% Retain VOF ROI coordinates that have a PDD in the Z direction</span>
0112     roi_tmp.coords = roi_tmp.coords(roi_pddZ,:);
0113     R_FG = dtiIntersectFibersWithRoi([],<span class="string">'and'</span>,[],roi_tmp,R_FG);
0114 <span class="keyword">end</span>
0115 <span class="comment">%R_FG = dtiIntersectFibersWithRoi([],'and',[],R_roi_2,R_FG);</span>
0116 <span class="comment">% Make sure endpoints are in the parietal lobe</span>
0117 R_FG = dtiIntersectFibersWithRoi([],<span class="string">'endpoints'</span>,4,R_roi_3,R_FG);
0118 <span class="comment">% And that fibers do not head to far anterior</span>
0119 R_FG = dtiIntersectFibersWithRoi([],<span class="string">'not'</span>,[],R_roi_not,R_FG);
0120 
0121 <span class="comment">% Name the fiber groups</span>
0122 L_FG.name = <span class="string">'L_Arcuate_Posterior'</span>;
0123 R_FG.name = <span class="string">'R_Arcuate_Posterior'</span>;
0124 
0125 <span class="comment">% Save the segmented fiber groups</span>
0126 dtiWriteFiberGroup(L_FG,fullfile(sub_dir,<span class="string">'fibers'</span>,L_FG.name));
0127 dtiWriteFiberGroup(R_FG,fullfile(sub_dir,<span class="string">'fibers'</span>,R_FG.name));
0128 
0129 <span class="comment">% Show the fiber group if desired</span>
0130 <span class="keyword">if</span> sum(strcmpi(<span class="string">'showfibers'</span>, varargin)) &gt; 0
0131     <a href="AFQ_RenderFibers.html" class="code" title="function lightH = AFQ_RenderFibers(fg,varargin)">AFQ_RenderFibers</a>(L_FG,<span class="string">'color'</span>,[0 0 1],<span class="string">'numfibers'</span>,300);
0132     b0 = readFileNifti(dt.files.b0);
0133     <a href="AFQ_AddImageTo3dPlot.html" class="code" title="function h = AFQ_AddImageTo3dPlot(nifti, slice, cmap, rescale, alpha, varargin)">AFQ_AddImageTo3dPlot</a>(b0,[-30 0 0]);
0134     <a href="AFQ_RenderRoi.html" class="code" title="function h = AFQ_RenderRoi(roi, color, method, render)">AFQ_RenderRoi</a>(L_roi_1);
0135 <span class="keyword">end</span>
0136 
0137 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Wed 14-Nov-2012 17:12:08 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>