<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AFQ_ComputeTractProperties</title>
  <meta name="keywords" content="AFQ_ComputeTractProperties">
  <meta name="description" content="Compute diffusion properties along the trajectory of the fiber groups.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">functions</a> &gt; AFQ_ComputeTractProperties.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>AFQ_ComputeTractProperties
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Compute diffusion properties along the trajectory of the fiber groups.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [fa, md, rd, ad, cl, TractProfile] = AFQ_ComputeTractProperties(fg_classified,dt,numberOfNodes,clip2rois,subDir, weighting, afq) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Compute diffusion properties along the trajectory of the fiber groups.
 The function returns vectors of diffusion properties and TractProfile
 structure for each fiber group

 [fa md rd ad cl TractProfile] = AFQ_ComputeTractProperties(fg_classified,dt,[numberOfNodes=30],[clip2rois=1],[subDir], [weighting = 1], afq)

 The input fiber group can either be a single fiber group or an array of
 fiber groups (See fg2Array). Each fiber group is clipped to its 2
 defining ROIs (if clip2rois == true). The fibers are sampled to a defined
 number of nodes (sampled at equidistant locations on each fiber) and
 flipped so that they start and end in an equivalent location (if
 clip2rois==false then we assume that fibers have already start and end in
 equivalent regions), then diffusion properties are calculated at each
 node as a weighted sum of the diffusion properties of each fiber at that
 node. The weights are determined based on each fibers gaussian distance
 from the core (mean) of the tract. Other quantitative maps can also be
 input into this function and Tract Profiles of these measures will be
 returned.

 Input arguments:
  fg_classified  = Fiber group classified into 20 subgroups that
                   correspond to each of the 20 tracts output by
                   AFQ_SegmentFiberGroups

  dt             = dt6 structure or an image file.

  numberOfNodes  = The number of nodes to sample each fiber to.

  clip2rois      = if clip2rois is set to 1 (default) then only the
                   central portion of the fiber group spanning between
                   the 2 defining ROIs is analyzed.
                   Otherwise the full trajectory is analyzed.

  subDir         = The directory containing the subjects dt6 file. This is
                   needed to find the subject's ROIs if clip2rois==1. By
                   defualt the subject's directory will be searched for
                   based on the path given in the dt6 file (dt.dataFile).
 weighting       = By default each fiber's contribution to the
                   measurement at the fiber tract core is weighted by its
                   gaussian distance from the core. This can also be
                   interpreted as the probability that it is a member of
                   the fiber group.  weighting defines the steepness of
                   the falloff of the weights assigned to each fiber where
                   a value of 0 means that there is no weighting and each
                   fiber contributes equally, a value of 1 means that we
                   use gaussian weighting (default) and values &gt;1 mean
                   that the weights fall off steaper as the fibers deviate
                   further from the core. Higher weighting values mean the
                   core is weighted more heavily compare to the periphery
                   of the tract.

 Outputs:
 fa               = vector of Fractional anisotropy along fiber core.
 md               = vector of Mean Diffusivity values along fiber core.
 rd               = vector of Radial Diffusivity values along fiber core.
 ad               = vector of Axial Diffusivity values along fiber core.
 cl               = vector of linearity values along fiber core.
 TractProfile     = TractProfile structure (see AFQ_CreateTractProfile).
                    Contains fiber group core, fiber covariance, and
                    fiber tract properties at each node.

  Example:

   AFQdata = '/home/jyeatman/matlab/svn/vistadata/AFQ'
   dt = dtiLoadDt6(fullfile(AFQdata,'subj2','dt6.mat'))
   fg_classified = AFQ_SegmentFiberGroups(dt)
   numberOfNodes = 30; clip2rois = 1; subDir = fullfile(AFQdata,'subj2');
   [fa md rd ad cl SuperFibersGroup] =
   AFQ_ComputeTractProperties(fg_classified,dt,numberOfNodes,clip2rois,subDir)

 Copyright Stanford Vista Team 2011
 Written by Jason D. Yeatman</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_CreateTractProfile.html" class="code" title="function TractProfile = AFQ_CreateTractProfile(varargin)">AFQ_CreateTractProfile</a>	Create the AFQ Tract Profile structure</li><li><a href="AFQ_LoadROIs.html" class="code" title="function [roi1, roi2] = AFQ_LoadROIs(fgNumber,sub_dir, afq)">AFQ_LoadROIs</a>	Load the two ROIs used to define a fiber group</li><li><a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>	Get value from afq structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_AddNewFiberGroup.html" class="code" title="function afq = AFQ_AddNewFiberGroup(afq,fgName,roi1Name,roi2Name,cleanFibers,computeVals)">AFQ_AddNewFiberGroup</a>	THIS FUNCTION IS STILL BEING DEVELOPED</li><li><a href="AFQ_run.html" class="code" title="function [afq patient_data control_data norms abn abnTracts] = AFQ_run(sub_dirs, sub_group, afq)">AFQ_run</a>	Run AFQ analysis on a set of subjects to generate Tract Profiles of white</li><li><a href="../tutorials/AFQ_example.html" class="code" title="">AFQ_example</a>	% Example AFQ analysis</li><li><a href="../tutorials/AFQ_example_GroupComparison.html" class="code" title="">AFQ_example_GroupComparison</a>	% Run AFQ analysis for 2 groups (patients and controls)</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [fa, md, rd, ad, cl, TractProfile] = AFQ_ComputeTractProperties(fg_classified,dt,numberOfNodes,clip2rois,subDir, weighting, afq)</a>
0002 <span class="comment">% Compute diffusion properties along the trajectory of the fiber groups.</span>
0003 <span class="comment">% The function returns vectors of diffusion properties and TractProfile</span>
0004 <span class="comment">% structure for each fiber group</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% [fa md rd ad cl TractProfile] = AFQ_ComputeTractProperties(fg_classified,dt,[numberOfNodes=30],[clip2rois=1],[subDir], [weighting = 1], afq)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% The input fiber group can either be a single fiber group or an array of</span>
0009 <span class="comment">% fiber groups (See fg2Array). Each fiber group is clipped to its 2</span>
0010 <span class="comment">% defining ROIs (if clip2rois == true). The fibers are sampled to a defined</span>
0011 <span class="comment">% number of nodes (sampled at equidistant locations on each fiber) and</span>
0012 <span class="comment">% flipped so that they start and end in an equivalent location (if</span>
0013 <span class="comment">% clip2rois==false then we assume that fibers have already start and end in</span>
0014 <span class="comment">% equivalent regions), then diffusion properties are calculated at each</span>
0015 <span class="comment">% node as a weighted sum of the diffusion properties of each fiber at that</span>
0016 <span class="comment">% node. The weights are determined based on each fibers gaussian distance</span>
0017 <span class="comment">% from the core (mean) of the tract. Other quantitative maps can also be</span>
0018 <span class="comment">% input into this function and Tract Profiles of these measures will be</span>
0019 <span class="comment">% returned.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% Input arguments:</span>
0022 <span class="comment">%  fg_classified  = Fiber group classified into 20 subgroups that</span>
0023 <span class="comment">%                   correspond to each of the 20 tracts output by</span>
0024 <span class="comment">%                   AFQ_SegmentFiberGroups</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  dt             = dt6 structure or an image file.</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%  numberOfNodes  = The number of nodes to sample each fiber to.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%  clip2rois      = if clip2rois is set to 1 (default) then only the</span>
0031 <span class="comment">%                   central portion of the fiber group spanning between</span>
0032 <span class="comment">%                   the 2 defining ROIs is analyzed.</span>
0033 <span class="comment">%                   Otherwise the full trajectory is analyzed.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%  subDir         = The directory containing the subjects dt6 file. This is</span>
0036 <span class="comment">%                   needed to find the subject's ROIs if clip2rois==1. By</span>
0037 <span class="comment">%                   defualt the subject's directory will be searched for</span>
0038 <span class="comment">%                   based on the path given in the dt6 file (dt.dataFile).</span>
0039 <span class="comment">% weighting       = By default each fiber's contribution to the</span>
0040 <span class="comment">%                   measurement at the fiber tract core is weighted by its</span>
0041 <span class="comment">%                   gaussian distance from the core. This can also be</span>
0042 <span class="comment">%                   interpreted as the probability that it is a member of</span>
0043 <span class="comment">%                   the fiber group.  weighting defines the steepness of</span>
0044 <span class="comment">%                   the falloff of the weights assigned to each fiber where</span>
0045 <span class="comment">%                   a value of 0 means that there is no weighting and each</span>
0046 <span class="comment">%                   fiber contributes equally, a value of 1 means that we</span>
0047 <span class="comment">%                   use gaussian weighting (default) and values &gt;1 mean</span>
0048 <span class="comment">%                   that the weights fall off steaper as the fibers deviate</span>
0049 <span class="comment">%                   further from the core. Higher weighting values mean the</span>
0050 <span class="comment">%                   core is weighted more heavily compare to the periphery</span>
0051 <span class="comment">%                   of the tract.</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% Outputs:</span>
0054 <span class="comment">% fa               = vector of Fractional anisotropy along fiber core.</span>
0055 <span class="comment">% md               = vector of Mean Diffusivity values along fiber core.</span>
0056 <span class="comment">% rd               = vector of Radial Diffusivity values along fiber core.</span>
0057 <span class="comment">% ad               = vector of Axial Diffusivity values along fiber core.</span>
0058 <span class="comment">% cl               = vector of linearity values along fiber core.</span>
0059 <span class="comment">% TractProfile     = TractProfile structure (see AFQ_CreateTractProfile).</span>
0060 <span class="comment">%                    Contains fiber group core, fiber covariance, and</span>
0061 <span class="comment">%                    fiber tract properties at each node.</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%  Example:</span>
0064 <span class="comment">%</span>
0065 <span class="comment">%   AFQdata = '/home/jyeatman/matlab/svn/vistadata/AFQ'</span>
0066 <span class="comment">%   dt = dtiLoadDt6(fullfile(AFQdata,'subj2','dt6.mat'))</span>
0067 <span class="comment">%   fg_classified = AFQ_SegmentFiberGroups(dt)</span>
0068 <span class="comment">%   numberOfNodes = 30; clip2rois = 1; subDir = fullfile(AFQdata,'subj2');</span>
0069 <span class="comment">%   [fa md rd ad cl SuperFibersGroup] =</span>
0070 <span class="comment">%   AFQ_ComputeTractProperties(fg_classified,dt,numberOfNodes,clip2rois,subDir)</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% Copyright Stanford Vista Team 2011</span>
0073 <span class="comment">% Written by Jason D. Yeatman</span>
0074 
0075 <span class="comment">% check the format of the fiber group. Convert to an array of fiber groups</span>
0076 <span class="comment">% if necessary</span>
0077 <span class="keyword">if</span> isstruct(fg_classified) &amp;&amp; isfield(fg_classified,<span class="string">'subgroupNames'</span>)<span class="keyword">...</span>
0078         &amp;&amp; isfield(fg_classified,<span class="string">'subgroup'</span>)
0079     fg_classified = fg2Array(fg_classified);
0080 <span class="keyword">end</span>
0081 <span class="comment">% if number of nodes doesn't exist then set to 30</span>
0082 <span class="keyword">if</span> ~exist(<span class="string">'numberOfNodes'</span>,<span class="string">'var'</span>) || isempty(numberOfNodes)
0083     numberOfNodes=30;
0084 <span class="keyword">end</span>
0085 <span class="keyword">if</span> ~exist(<span class="string">'clip2rois'</span>,<span class="string">'var'</span>) || isempty(clip2rois)
0086     clip2rois=1;
0087 <span class="keyword">end</span>
0088 <span class="comment">% check if the dt input is a dt6 structure or a nifti image</span>
0089 <span class="keyword">if</span> isfield(dt,<span class="string">'qto_xyz'</span>)
0090     valname = <span class="string">'image'</span>;
0091 <span class="keyword">else</span>
0092     valname = <span class="string">'dt'</span>;
0093 <span class="keyword">end</span>
0094 <span class="comment">% if no subject directory was defined then define based on the dt6 file</span>
0095 <span class="keyword">if</span> ~exist(<span class="string">'subDir'</span>,<span class="string">'var'</span>) || isempty(subDir) &amp;&amp; strcmp(valname, <span class="string">'dt'</span>)
0096     subDir = fileparts(dt.dataFile);
0097 <span class="keyword">end</span>
0098 <span class="comment">% Check if a weighting factor was defined otherwise set to gaussian</span>
0099 <span class="comment">% weighting</span>
0100 <span class="keyword">if</span> ~exist(<span class="string">'weighting'</span>,<span class="string">'var'</span>) || isempty(weighting)
0101     weighting = 1;
0102 <span class="keyword">end</span>
0103 <span class="comment">% Number of fiber groups</span>
0104 numfg = length(fg_classified);
0105 <span class="comment">% Create Tract Profile structure</span>
0106 TractProfile = <a href="AFQ_CreateTractProfile.html" class="code" title="function TractProfile = AFQ_CreateTractProfile(varargin)">AFQ_CreateTractProfile</a>;
0107 <span class="comment">% Pre allocate data arrays</span>
0108 fa=nan(numberOfNodes,numfg);
0109 md=nan(numberOfNodes,numfg);
0110 rd=nan(numberOfNodes,numfg);
0111 ad=nan(numberOfNodes,numfg);
0112 cl=nan(numberOfNodes,numfg);
0113 <span class="comment">% loop over the fiber groups</span>
0114 <span class="keyword">for</span> jj=1:numfg
0115     <span class="comment">% There are 20 fiber groups saved within the same structure. We will</span>
0116     <span class="comment">% loop over these fiber groups, allocate them to a tmp variable</span>
0117     <span class="comment">% calculate what we need and move on</span>
0118     fgtmp = fg_classified(jj);
0119     
0120     <span class="comment">% This is what we would do with the old fiber group structure</span>
0121     <span class="comment">% fgtmp=dtiNewFiberGroup(fg_classified.subgroupNames(jj).subgroupName);</span>
0122     <span class="comment">%  fgtmp.fibers=fg_classified.fibers(fg_classified.subgroup==jj);</span>
0123     
0124     <span class="comment">% Figure out the fiber group number if an afq structure was passed in</span>
0125     <span class="keyword">if</span> exist(<span class="string">'afq'</span>,<span class="string">'var'</span>) &amp;&amp; ~isempty(afq)
0126         fgnames = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(afq,<span class="string">'fgnames'</span>);
0127         fgnum = find(strcmpi(fgtmp.name, fgnames));
0128         <span class="keyword">if</span> isempty(fgnum)
0129             fgnum = jj;
0130             fprintf(<span class="string">'\n%s does not match any fiber group name in the afq structure.'</span>, fgtmp.name);
0131             fprintf(<span class="string">'\n Assuming that it is equivalent to %s'</span>,fgnames{jj});
0132         <span class="keyword">end</span>
0133     <span class="keyword">else</span>
0134         fgnum = jj;
0135     <span class="keyword">end</span>
0136     <span class="comment">% clip the fiber group to the portion spanning between the two ROIs if</span>
0137     <span class="comment">% desired</span>
0138     <span class="keyword">if</span> clip2rois==1 &amp;&amp; exist(<span class="string">'afq'</span>,<span class="string">'var'</span>) &amp;&amp; ~isempty(afq)
0139         [roi1, roi2] = <a href="AFQ_LoadROIs.html" class="code" title="function [roi1, roi2] = AFQ_LoadROIs(fgNumber,sub_dir, afq)">AFQ_LoadROIs</a>(fgnum,subDir,afq);
0140     <span class="keyword">elseif</span> clip2rois==1
0141         [roi1, roi2] = <a href="AFQ_LoadROIs.html" class="code" title="function [roi1, roi2] = AFQ_LoadROIs(fgNumber,sub_dir, afq)">AFQ_LoadROIs</a>(fgnum,subDir);
0142     <span class="keyword">else</span>
0143         roi1=[]; roi2=[];
0144     <span class="keyword">end</span>
0145     <span class="comment">% Some subjects may be missing certain fiber groups due to lesions,</span>
0146     <span class="comment">% or noise in the data.  If a fiber group is empty we will ad NaNs to</span>
0147     <span class="comment">% the database</span>
0148     <span class="keyword">if</span> isempty(fgtmp.fibers)
0149         fa(:, jj)=nan;md(:, jj)=nan;rd(:, jj)=nan;ad(:, jj)=nan;cl(:, jj)=nan;
0150         TractProfile(jj) = <a href="AFQ_CreateTractProfile.html" class="code" title="function TractProfile = AFQ_CreateTractProfile(varargin)">AFQ_CreateTractProfile</a>(<span class="string">'name'</span>,fgtmp.name);
0151         <span class="keyword">continue</span>
0152     <span class="keyword">end</span>
0153     <span class="comment">% Here is where we will create define the fiber group core and calculate</span>
0154     <span class="comment">% stats based on the method described in Yeatman et al 2011. Sometimes</span>
0155     <span class="comment">% there is a problem such as only having 1 fiber in the fiber group.</span>
0156     <span class="comment">% To avoid breaking the whole loop we use the try catch loop</span>
0157     <span class="keyword">try</span>
0158         [fa(:, jj),md(:, jj),rd(:, jj),ad(:, jj),cl(:, jj),SuperFibersGroup(jj)]=dtiComputeDiffusionPropertiesAlongFG(fgtmp, dt, roi1, roi2, numberOfNodes,weighting);
0159         <span class="comment">% Put mean fiber into Tract Profile structure</span>
0160         TractProfile(jj) = <a href="AFQ_CreateTractProfile.html" class="code" title="function TractProfile = AFQ_CreateTractProfile(varargin)">AFQ_CreateTractProfile</a>(<span class="string">'name'</span>,fgtmp.name,<span class="string">'superfiber'</span>,SuperFibersGroup(jj));
0161     <span class="keyword">catch</span>
0162         fa(:, jj)=nan;md(:, jj)=nan;rd(:, jj)=nan;ad(:, jj)=nan;cl(:, jj)=nan;
0163         TractProfile(jj) = <a href="AFQ_CreateTractProfile.html" class="code" title="function TractProfile = AFQ_CreateTractProfile(varargin)">AFQ_CreateTractProfile</a>(<span class="string">'name'</span>,fgtmp.name);
0164     <span class="keyword">end</span>
0165 <span class="keyword">end</span>
0166 
0167 
0168 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Wed 05-Dec-2012 12:03:42 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>