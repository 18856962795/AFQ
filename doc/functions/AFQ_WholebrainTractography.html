<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AFQ_WholebrainTractography</title>
  <meta name="keywords" content="AFQ_WholebrainTractography">
  <meta name="description" content="Perform whole brain deterministic tractography within a white matter mask">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">functions</a> &gt; AFQ_WholebrainTractography.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>AFQ_WholebrainTractography
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Perform whole brain deterministic tractography within a white matter mask</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function fg = AFQ_WholebrainTractography(dt,run_mode,params) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Perform whole brain deterministic tractography within a white matter mask

      fg = AFQ_WholebrainTractography(dt, [run_mode], params)

 Inputs:
 dt       = a dt6 structure (generated by dtiInit).
 run_mode = If 'test' then fewer (10K) fibers are tracked for efficient
            debugging. This is achieved by setting a higher fa mask
            threshold and fewer seeds per voxel.  Otherwise don't define.
 params   = A structure of parameters defining the fiber parameters for
            fiber tracking. Can also be an AFQ structure which contains
            these parameters
 Outputs:
 fg       = A wholebrain fiber group.

 Example:

 dt = dtiLoadDt6('subj1/dt6.mat')
 fg = AFQ_WholebrainTractography(dt);

 (c) Jason Yeatman, VISTA Lab, Stanford University, 2011</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>	Get value from afq structure</li><li><a href="../utilities/isafq.html" class="code" title="function log = isafq(afq)">isafq</a>	Check if a variable is an afq structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AFQ_SegmentFiberGroups.html" class="code" title="function [fg_classified,fg_unclassified,classification,fg] =AFQ_SegmentFiberGroups(dt6File, fg, Atlas,useRoiBasedApproach, useInterhemisphericSplit)">AFQ_SegmentFiberGroups</a>	Categorizes each fiber in a group into one of the 20 tracts defined in</li><li><a href="AFQ_Segment_PostArcuate.html" class="code" title="function [L_FG, R_FG, L_roi_1, L_roi_2, R_roi_1, R_roi_2] = AFQ_Segment_PostArcuate(dt, wholebrainFG, varargin)">AFQ_Segment_PostArcuate</a>	Define the posterior segment of the arcuate from a wholebrain fiber group</li><li><a href="AFQ_run.html" class="code" title="function [afq patient_data control_data norms abn abnTracts] = AFQ_run(sub_dirs, sub_group, afq)">AFQ_run</a>	Run AFQ analysis on a set of subjects to generate Tract Profiles of white</li><li><a href="../tutorials/AFQ_example.html" class="code" title="">AFQ_example</a>	% Example AFQ analysis</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function fg = AFQ_WholebrainTractography(dt,run_mode,params)</a>
0002 <span class="comment">% Perform whole brain deterministic tractography within a white matter mask</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%      fg = AFQ_WholebrainTractography(dt, [run_mode], params)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Inputs:</span>
0007 <span class="comment">% dt       = a dt6 structure (generated by dtiInit).</span>
0008 <span class="comment">% run_mode = If 'test' then fewer (10K) fibers are tracked for efficient</span>
0009 <span class="comment">%            debugging. This is achieved by setting a higher fa mask</span>
0010 <span class="comment">%            threshold and fewer seeds per voxel.  Otherwise don't define.</span>
0011 <span class="comment">% params   = A structure of parameters defining the fiber parameters for</span>
0012 <span class="comment">%            fiber tracking. Can also be an AFQ structure which contains</span>
0013 <span class="comment">%            these parameters</span>
0014 <span class="comment">% Outputs:</span>
0015 <span class="comment">% fg       = A wholebrain fiber group.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Example:</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% dt = dtiLoadDt6('subj1/dt6.mat')</span>
0020 <span class="comment">% fg = AFQ_WholebrainTractography(dt);</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% (c) Jason Yeatman, VISTA Lab, Stanford University, 2011</span>
0023 
0024 <span class="comment">%% Initialize parameters</span>
0025 
0026 <span class="keyword">if</span> ~exist(<span class="string">'params'</span>,<span class="string">'var'</span>) || isempty(params)
0027     <span class="comment">% This defines which voxels will be seeded for tractography.</span>
0028     <span class="keyword">if</span> ~exist(<span class="string">'run_mode'</span>,<span class="string">'var'</span>) || isempty(run_mode)
0029         opts.faMaskThresh = 0.30;
0030     <span class="keyword">elseif</span> strcmp(run_mode,<span class="string">'test'</span>)
0031         <span class="comment">% Set a higher fa threshold, to reduce the number of fibers.</span>
0032         opts.faMaskThresh = 0.35;
0033     <span class="keyword">end</span>
0034     <span class="comment">% Distance between steps in the tractography algoithm</span>
0035     opts.stepSizeMm = 1;
0036     <span class="comment">% Stopping criteria FA&lt;0.2</span>
0037     opts.faThresh = 0.2;
0038     <span class="comment">% Discard Fibers shorter than 50mm or longer than 250mm</span>
0039     opts.lengthThreshMm = [50 250];
0040     <span class="comment">% Stopping criteria angle between steps &gt;30 degrees</span>
0041     opts.angleThresh = 30;
0042     <span class="comment">% Unknown.....</span>
0043     opts.wPuncture = 0.2;
0044     <span class="comment">% There are multip.e algorithms that can be used.  We prefer STT. See:</span>
0045     <span class="comment">% Basser PJ, Pajevic S, Pierpaoli C, Duda J, Aldroubi A. 2000.</span>
0046     <span class="comment">% In vivo fiber tractography using DT-MRI data.</span>
0047     <span class="comment">% Magnetic Resonance in Medicine 44(4):625-32.</span>
0048     opts.whichAlgorithm = 1;
0049     <span class="comment">% Interpolation method. After each step we interpolate the tensor at that</span>
0050     <span class="comment">% point. Trilinear interpolation works well.</span>
0051     opts.whichInterp = 1;
0052     <span class="comment">% This adds some randomness to each seed point. Each seed point is move</span>
0053     <span class="comment">% randomly by randn*.1mm</span>
0054     opts.offsetJitter = 0;
0055     <span class="comment">% We seed in voxel in multiple locations. [0.25 and 0.75] Seeds each voxel</span>
0056     <span class="comment">% at 8 equidistant locations.  For one seed in the middle of the voxel use</span>
0057     <span class="comment">% opts.seedVoxelOffsets = 0.5;</span>
0058     <span class="keyword">if</span> ~exist(<span class="string">'run_mode'</span>,<span class="string">'var'</span>) || isempty(run_mode)
0059         opts.seedVoxelOffsets = [0.25 0.75];
0060     <span class="keyword">elseif</span> strcmp(run_mode,<span class="string">'test'</span>)
0061         opts.seedVoxelOffsets = [0.5];
0062     <span class="keyword">end</span>
0063 <span class="keyword">elseif</span> <a href="../utilities/isafq.html" class="code" title="function log = isafq(afq)">isafq</a>(params)
0064     <span class="comment">% If an afq structure is passed in get the tracking parameters and also</span>
0065     <span class="comment">% check if tracking should be done based on CSD with mrtrix</span>
0066     opts = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(params,<span class="string">'tracking parameters'</span>);
0067     mrtrix = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(params,<span class="string">'use mrtrix'</span>);
0068 <span class="keyword">else</span>
0069     <span class="comment">% Check to make sure the user defined all the propper parameters</span>
0070     check = isfield(params,<span class="string">'seedVoxelOffsets'</span>)&amp;&amp;isfield(params,<span class="string">'whichInterp'</span>)&amp;&amp;<span class="keyword">...</span>
0071         isfield(params,<span class="string">'faThresh'</span>)&amp;&amp;isfield(params,<span class="string">'whichAlgorithm'</span>);
0072     <span class="keyword">if</span> check == 0
0073         error(<span class="string">'You did not define all the parameters! Try running with dafaults'</span>)
0074     <span class="keyword">end</span>
0075 <span class="keyword">end</span>
0076 
0077 <span class="comment">%% Track with mrtrix if the right files are there</span>
0078 <span class="keyword">if</span> exist(<span class="string">'mrtrix'</span>,<span class="string">'var'</span>) &amp;&amp; mrtrix == 1
0079     mrtrixpaths = <a href="AFQ_get.html" class="code" title="function val = AFQ_get(afq, param, varargin)">AFQ_get</a>(params,<span class="string">'mrtrix paths'</span>,params.currentsub);
0080     [status, results, fg, pathstr] = mrtrix_track(mrtrixpaths.csd, mrtrixpaths.wm, mrtrixpaths.wm, <span class="string">'stream'</span>, 500000,[],[],1);
0081 <span class="keyword">else</span>
0082     <span class="comment">%% Otherwise track with mrdiffusion</span>
0083     <span class="comment">% Compute FA at every voxel</span>
0084     fa = dtiComputeFA(dt.dt6);
0085     <span class="comment">% Sometimes noise can cause impossible FA values so we clip them</span>
0086     fa(fa&gt;1) = 1; fa(fa&lt;0) = 0;
0087     
0088     <span class="comment">%% Create an ROI for wholebrain tractography</span>
0089     roiAll = dtiNewRoi(<span class="string">'all'</span>);
0090     <span class="comment">% Make a mask of voxels with FA&gt;faMaskThresh</span>
0091     mask = fa &gt;= opts.faMaskThresh;
0092     <span class="comment">% Convert mask image to a list of coordinates</span>
0093     [x,y,z] = ind2sub(size(mask), find(mask));
0094     clear mask fa;
0095     <span class="comment">% Transofrm mask coordinates to subjects ACPC space</span>
0096     roiAll.coords = mrAnatXformCoords(dt.xformToAcpc, [x,y,z]);
0097     clear x y z;
0098     <span class="comment">% Smooth the ROI and fill holes</span>
0099     roiAll = dtiRoiClean(roiAll,3,{<span class="string">'fillHoles'</span>});
0100     
0101     <span class="comment">%% Perform wholebrain tractography</span>
0102     fg = dtiFiberTrack(dt.dt6, roiAll.coords, dt.mmPerVoxel, dt.xformToAcpc, <span class="string">'wholeBrain'</span>, opts);
0103     
0104 <span class="keyword">end</span>
0105 <span class="keyword">return</span>
0106 
0107 <span class="comment">%% Comments and debugging</span>
0108</pre></div>
<hr><address>Generated on Wed 05-Dec-2012 12:03:42 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>